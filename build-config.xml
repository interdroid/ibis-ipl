<project
    name="build-config"
    default="configure"
    basedir=".">

    <description>
      Install-time configuration.
      Figure out where the packages are that we depend on.
    </description>


    <property name="config.home.bcel" location="3rdparty/bcel-5.1.jar"/>
    <property name="config.home.ant-contrib" location="3rdparty/ant-contrib-0.4.jar"/>
    <property name="config.home.ant-cpptasks" location="3rdparty/cpptasks-1.0-cvs.jar"/>


    <target name="config.previous"
	    depends="config-set-os"
	    if="config.has-previous">
	<echo message="Read previous configuration from build-properties.cache"/>
	<property file="build-properties.cache"/>
    </target>

    <target name="config.das"
	    depends="config-set-os"
	    if="config.is-das">
	<property
		name="default.home.panda"
		location="/usr/local/VU/panda/panda4.0"/>
	<property
		name="default.home.daslib"
		location="/usr/local/VU/daslib"/>
	<property
		name="default.home.lfc"
		location="/usr/local/VU/lfc/lfc-gm"/>
	<property
		name="default.home.mpi"
		location="/usr/local/mpich/mpich-gm"/>
	<property
		name="default.home.gm"
		location="/usr/local/gm/current"/>
    </target>

    <target name="config.workstation"
	    depends="config-set-os"
	    if="config.is-workstation">
	<property
		name="default.home.panda"
		location="../panda/panda4.0"/>
	<property
		name="default.home.daslib"
		location="../daslib"/>
	<property
		name="default.home.lfc"
		location="../lfc-gm"/>
	<property
		name="default.home.mpi"
		location="/usr/local/mpich/mpich-gm"/>
	<property
		name="default.home.gm"
		location="../GM"/>
    </target>

    <target name="config.mac"
	    depends="config-set-os"
	    if="config.os-is-mac">
	<echo message="Yep, this is a mac"/>
    </target>

    <target name="config-domainname" depends="proprietary-tasks">
	<hostname hostname="hostname" domainname="domainname"/>
	<echo message="Hostname ${hostname} domainname ${domainname}"/>
	<condition property="config.has-previous">
	    <available file="build-properties.cache"/>
	</condition>
	<condition property="config.is-das">
	    <and>
		<not>
		    <isset property="config.has-previous"/>
		</not>
		<or>
		    <equals arg1="${domainname}" arg2="das2.cs.vu.nl"/>
		    <!-- <equals arg1="${domainname}" arg2="cs.vu.nl"/> -->
		    <equals arg1="${domainname}" arg2="das2.liacs.nl"/>
		    <equals arg1="${domainname}" arg2="das2.nikhef.nl"/>
		    <equals arg1="${domainname}" arg2="das2.its.tudelft.nl"/>
		    <equals arg1="${domainname}" arg2="das2.phys.uu.nl"/>

		    <!-- Dunno why but the VU DAS workstations are not in
			 the DAS domain -->
		    <equals arg1="${hostname}" arg2="mercury.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="titan.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="venus.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="mars.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="drum.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="kog.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="swpc429.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc060.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc061.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc062.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc063.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc064.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc065.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc066.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc067.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc068.cs.vu.nl"/>
		    <equals arg1="${hostname}" arg2="fspc069.cs.vu.nl"/>
		</or>
	    </and>
	</condition>
	<condition property="config.is-workstation">
	    <and>
		<not>
		    <isset property="config.has-previous"/>
		</not>
		<not>
		    <isset property="config.is-das"/>
		</not>
	    </and>
	</condition>
	<echo message="config.is-das = ${config.is-das}"/>
    </target>

    <target name="config-set-os" depends="config-domainname">
	<condition property="config.os-is-unix"    value="true">
	    <os family="unix"/>
	</condition>
	<condition property="config.os-is-windows" value="true">
	    <os family="windows"/>
	</condition>
	<condition property="config.os-is-mac"     value="true">
	    <os family="mac"/>
	</condition>
    </target>

    <target name="config-init" depends="config.das,config.workstation,config.mac,config.previous">

	<property name="JAVA_HOME_ENV" value="${env.JAVA_HOME}"/>
    </target>

    <target name="compile.java_wrapper" depends="cpptasks-init">
	<echo message="Now compile this java_wrapper"/>
	<cc	outfile="${ibis}/bin/java_wrapper"
		outtype="executable">
	    <fileset dir="${ibis}/src/ibis/util">
		<include name="java_wrapper.c"/>
	    </fileset>
	</cc>
    </target>

    <target name="java_wrapper" if="config.is-das">
	<ant target="compile.java_wrapper" inheritAll="false">
	    <property name="ibis" value="${ibis}"/>
	</ant>
    </target>

    <property environment="env"/>

    <target name="-config-build-properties">

	<echo>
----------------------------------------------------------------
Now, your Ibis build is being configured under ${ibis}.

If you don't have any fast local networks for which a special
Ibis module is required, you may skip the following message
by just hitting the 'enter' key.

If you wish to configure Ibis modules for fast local networks,
you have to do some extra configuration. To do so, type:
  ant configure
to the command line, and answer questions.
If you don't know the answer, or don't have the native modules
that the fast local network module depends on, just hitting
the 'enter' key is usually OK.
After you did this optional configuration, you must again type:
  ant
to the command line.
----------------------------------------------------------------
</echo>
	<input
		message="Hit the 'enter' key to contiue"
		addproperty="answer.config.continue"/>

	<property name="config.home.ibis" location="${ibis}"/>

	<condition property="config.home.gm-s" value="${default.home.gm}">
	    <equals arg1="${install.home.gm}" arg2=""/>
	</condition>
	<condition property="config.home.gm-s" value="${install.home.gm}">
	    <not>
		<equals arg1="${install.home.gm}" arg2=""/>
	    </not>
	</condition>
	<property name="config.home.gm"
		location="${config.home.gm-s}"/>

	<condition property="config.home.daslib-s" value="${default.home.daslib}">
	    <equals arg1="${install.home.daslib}" arg2=""/>
	</condition>
	<condition property="config.home.daslib-s" value="${install.home.daslib}">
	    <not>
		<equals arg1="${install.home.daslib}" arg2=""/>
	    </not>
	</condition>
	<property name="config.home.daslib"
		location="${config.home.daslib-s}"/>

	<condition property="config.home.lfc-s" value="${default.home.lfc}">
	    <equals arg1="${install.home.lfc}" arg2=""/>
	</condition>
	<condition property="config.home.lfc-s" value="${install.home.lfc}">
	    <not>
		<equals arg1="${install.home.lfc}" arg2=""/>
	    </not>
	</condition>
	<property name="config.home.lfc"
		location="${config.home.lfc-s}"/>

	<condition property="config.home.panda-s" value="${default.home.panda}">
	    <equals arg1="${install.home.panda}" arg2=""/>
	</condition>
	<condition property="config.home.panda-s" value="${install.home.panda}">
	    <not>
		<equals arg1="${install.home.panda}" arg2=""/>
	    </not>
	</condition>
	<property name="config.home.panda"
		location="${config.home.panda-s}"/>

	<condition property="config.home.mpi-s" value="${default.home.mpi}">
	    <equals arg1="${install.home.mpi}" arg2=""/>
	</condition>
	<condition property="config.home.mpi-s" value="${install.home.mpi}">
	    <not>
		<equals arg1="${install.home.mpi}" arg2=""/>
	    </not>
	</condition>
	<property name="config.home.mpi"
		location="${config.home.mpi-s}"/>

	<delete file="build-properties.cache"/>
	<echo	file="build-properties.cache"
		append="true">default.home.panda  = ${default.home.panda}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.daslib = ${default.home.daslib}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.lfc    = ${default.home.lfc}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.mpi    = ${default.home.mpi}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.gm     = ${default.home.gm}
</echo>

	<!--
	<echo	file="config.status"
		append="true">${config.home.ant-contrib}
	</echo>
	<echo	file="config.status"
		append="true">${config.home.ant-cpptasks}
	</echo>
	-->

	<copy	file="${ibis}/build-properties"
		tofile="${ibis}/build-properties.backup"
		failonerror="false"
		overwrite="true">
	</copy>
	<copy	file="${ibis}/build-properties.in"
		tofile="${ibis}/build-properties"
		overwrite="true">
	</copy>

	<replaceregexp
		file="${ibis}/build-properties"
		flags="g"
		match="\${file.separator}"
		replace="/"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@JAVA@"
		replace="${JAVA_HOME_ENV}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@IBIS@"
		replace="${config.home.ibis}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@BCEL_HOME@"
		replace="${config.home.bcel}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@ANT_CPPTASKS@"
		replace="${config.home.ant-cpptasks}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@ANT_CONTRIB@"
		replace="${config.home.ant-contrib}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@GM_HOME@"
		replace="${config.home.gm}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@DASLIB_HOME@"
		replace="${config.home.daslib}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@LFC_HOME@"
		replace="${config.home.lfc}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@PANDA_HOME@"
		replace="${config.home.panda}"/>
	<replaceregexp
		file="${ibis}/build-properties"
		match="@MPI_HOME@"
		replace="${config.home.mpi}"/>


	<!--
	==============================================================
	    Generate configuration.sh
	-->

	<condition property="JIT_OPTS" value="${env.JIT_OPTS}">
	    <isset property="env.JIT_OPTS"/>
	</condition>
	<condition property="JIT_OPTS" value="">
	    <not>
		<isset property="env.JIT_OPTS"/>
	    </not>
	</condition>

	<echo
		file="${ibis}/configuration.sh">#!/bin/bash
# Shell variables to describe Ibis configuration

</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">JAVA_ROOT=${JAVA_HOME_ENV}
</echo>
	<property name="config.javac" location="${JAVA_HOME_ENV}/bin/javac"/>
	<echo
		append="true"
		file="${ibis}/configuration.sh">JAVAC=${config.javac}
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">JIT_OPTS="${JIT_OPTS}"
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">IBIS_ROOT=${ibis}
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">MANTA_ROOT=/usr/local/VU/manta
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">PANDA_ROOT=${config.home.panda}
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">LFC_ROOT=${config.home.lfc}
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">GM_ROOT=${config.home.gm}
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">DAS_LIB=${config.home.daslib}/lib/i386_Linux/libdas.a
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">PANDA_NETWORK=lfc
</echo>
	<echo
		append="true"
		file="${ibis}/configuration.sh">BCEL=${config.home.bcel}
</echo>

	<!-- Concat the stuff in scripts to the bin directory -->
	<mkdir dir="${ibis}/bin"/>

	<concat destfile="${ibis}/bin/ibisc">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/ibisc" />
	</concat>
	<chmod file="${ibis}/bin/ibisc" perm="+x"/>

	<concat destfile="${ibis}/bin/io_gen">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/io_gen" />
	</concat>
	<chmod file="${ibis}/bin/io_gen" perm="+x"/>

	<concat destfile="${ibis}/bin/ibis_nameserver">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/ibis_nameserver" />
	</concat>
	<chmod file="${ibis}/bin/ibis_nameserver" perm="+x"/>

	<concat destfile="${ibis}/bin/jdis">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/jdis" />
	</concat>
	<chmod file="${ibis}/bin/jdis" perm="+x"/>

	<concat destfile="${ibis}/bin/jp">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/jp" />
	</concat>
	<chmod file="${ibis}/bin/jp" perm="+x"/>

	<concat destfile="${ibis}/bin/satinc">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/satinc" />
	</concat>
	<chmod file="${ibis}/bin/satinc" perm="+x"/>

	<concat destfile="${ibis}/bin/run_ibis">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/run_ibis" />
	</concat>
	<chmod file="${ibis}/bin/run_ibis" perm="+x"/>

	<concat destfile="${ibis}/bin/extract_jars">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/extract_jars" />
	</concat>
	<chmod file="${ibis}/bin/extract_jars" perm="+x"/>

	<concat destfile="${ibis}/bin/tree_ioc">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/tree_ioc" />
	</concat>
	<chmod file="${ibis}/bin/tree_ioc" perm="+x"/>

	<concat destfile="${ibis}/bin/run_ibis_wide_area">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/run_ibis_wide_area" />
	</concat>
	<chmod file="${ibis}/bin/run_ibis_wide_area" perm="+x"/>

	<concat destfile="${ibis}/bin/grun">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/grun" />
	</concat>
	<chmod file="${ibis}/bin/grun" perm="+x"/>

	<concat destfile="${ibis}/bin/pprun">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/pprun" />
	</concat>
	<chmod file="${ibis}/bin/pprun" perm="+x"/>

	<concat destfile="${ibis}/bin/frun">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/frun" />
	</concat>
	<chmod file="${ibis}/bin/frun" perm="+x"/>

	<!--
	    Right for now, this is used only by me = RFHH so I hard-code
	    ibis NS port and host. This should become a configuration
	    thingy whenever other peope also want to use run-das
	-->
	<concat destfile="${ibis}/bin/run-das">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/run-das" />
	</concat>
	<replace file="${ibis}/bin/run-das" token="@IBIS_NS_PORT@" value="7654"/>
	<replace file="${ibis}/bin/run-das" token="@IBIS_NS_HOST@" value="mercury.cs.vu.nl"/>
	<chmod file="${ibis}/bin/run-das" perm="+x"/>

	<copy
		overwrite="true"
		file="${ibis}/scripts/cluster_wrapper.in"
		tofile="${ibis}/bin/cluster_wrapper">
	    <filterchain>
		<filterreader
			classname="org.apache.tools.ant.filters.ReplaceTokens">
		    <param  type="token"
			    name="IBIS_INSTALL_PATH"
			    value="${ibis}"/>
		    <param  type="token"
			    name="JAVA"
			    value="${JAVA_HOME_ENV}"/>
		</filterreader>
	    </filterchain>
	</copy>
	<replaceregexp
		file="${ibis}/bin/cluster_wrapper"
		flags="g"
		match="\${file.separator}"
		replace="/"/>
	<chmod file="${ibis}/bin/cluster_wrapper" perm="+x"/>

	<concat destfile="${ibis}/bin/csim_run_ibis">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/csim_run_ibis" />
	</concat>
	<chmod file="${ibis}/bin/csim_run_ibis" perm="+x"/>

	<concat destfile="${ibis}/bin/csim_run_ibis_tcp">
	    <filelist dir="${ibis}" files="configuration.sh,scripts/csim_run_ibis_tcp" />
	</concat>
	<chmod file="${ibis}/bin/csim_run_ibis_tcp" perm="+x"/>

	<copy
		overwrite="true"
		file="${ibis}/configuration.sh"
		tofile="${ibis}/configuration.bat">
	</copy>
	<replaceregexp
		file="${ibis}/configuration.bat"
		flags="g"
		match="#"
		replace="rem "/>
	<replaceregexp
		file="${ibis}/configuration.bat"
		flags="g"
		match="Shell"
		replace="Windows cmd"/>
	<replaceregexp
		file="${ibis}/configuration.bat"
		flags="g"
		match="(.*)="
		replace="set \1="/>

	<concat destfile="${ibis}/bin/run_ibis.bat">
	    <filelist dir="${ibis}" files="configuration.bat,scripts/run_ibis.bat" />
	</concat>
	<chmod file="${ibis}/bin/run_ibis.bat" perm="+x"/>

	<concat destfile="${ibis}/bin/ibis_nameserver.bat">
	    <filelist dir="${ibis}" files="configuration.bat,scripts/ibis_nameserver.bat" />
	</concat>
	<chmod file="${ibis}/bin/ibis_nameserver.bat" perm="+x"/>

	<antcall target="java_wrapper"/>
    </target>


    <target name="-config-lazy-build-properties"
	    unless="build-properties-available">
	<antcall inheritRefs="true" target="-config-build-properties"/>
    </target>


    <target name="config-init-initial" depends="config-init">
	<condition property="build-properties-available">
	    <available file="build-properties"/>
	</condition>
	<antcall inheritRefs="true" target="-config-lazy-build-properties"/>
    </target>


    <target name="java-home-test" depends="config-init" unless="env.JAVA_HOME">
	<fail>Environment variable JAVA_HOME is not set!</fail>
    </target>


    <target name="configure"
	    depends="config-init, java-home-test"
	    description="Ibis build configuration for high-speed LAN modules">

	<input
		message="Please enter the install directory of gm: [${default.home.gm}] "
		addproperty="install.home.gm"/>
	<input
		message="Please enter the install directory of daslib: [${default.home.daslib}] "
		addproperty="install.home.daslib"/>
	<input
		message="Please enter the install directory of lfc: [${default.home.lfc}] "
		addproperty="install.home.lfc"/>
	<input
		message="Please enter the install directory of panda: [${default.home.panda}] "
		addproperty="install.home.panda"/>
	<input
		message="Please enter the install directory of mpi: [${default.home.mpi}] "
		addproperty="install.home.mpi"/>


	<antcall inheritRefs="true" target="-config-build-properties"/>
    </target>


</project>
