<!DOCTYPE project [
    <!ENTITY sharedProperties SYSTEM "../../../../build-properties.xml">
    <!ENTITY nativeTargets    SYSTEM "../../../../build-native.xml">
]>

<project
    name="ibis.ipl.impl.messagePassing.panda.native"
    default="build"
    basedir=".">

    <description>
	Compile natives in this directory

	Expect to inherit the following properties:
	    native.dir		the directory of this build
	    ibis		the root of the ibis source tree
	    native-path		${native.dir} relative to ${ibis}
	    build		the root of the ibis build tree
	    default.classpath	a ref property with default classpath

	The shared target definitions require you to define:
	    local.includes	a property that contains include paths specific
				to this module

	Optional:
	    local.lib		the truncated name of the lib you want to create
    </description>

    <property name="local.lib" value="ibis_local_mp_panda"/>
    <property name="closure.lib" value="ibis_mp_panda"/>

    &sharedProperties;
    &nativeTargets;

    <target name="arch-init" depends="property-init">

	<condition property="panda.arch" value="i386_linux">
	    <isset property="os-is-unix"/>
	</condition>
	<condition property="panda.arch" value="i386_win32">
	    <isset property="os-is-windows"/>
	</condition>
	<condition property="panda.arch" value="ppc_osX">
	    <isset property="os-is-mac"/>
	</condition>

	<path id="local.includes-ref">
	    <pathelement path="${native.dir}/../include"/>
	    <pathelement path="${package.home.panda}/include"/>
	    <pathelement path="${package.home.panda}/include/${panda.arch}/lfc/no_threads"/>
	    <pathelement path="${package.home.daslib}/include"/>
	</path>
	<property name="local.includes" refid="local.includes-ref"/>
	<echo message="local.includes = ${local.includes}"/>

	<if>
	    <os family="unix"/>
	    <then>
		<property name="das.lib.dir" location="${package.home.daslib}/lib/i386_Linux"/>
		<property name="gm.lib.dir"  location="${package.home.gm}/lib"/>
		<path id="local.includes-ref">
		    <pathelement path="${package.home.gm}/include"/>
		</path>
	    </then>
	<elseif>
	    <os family="windows"/>
	    <then>
		<property name="das.lib.dir" location="${package.home.daslib}/lib/i386_win32"/>
		<property name="gm.lib.dir"  location="${package.home.gm}"/>
		<path id="local.includes-ref">
		    <pathelement path="${package.home.gm}"/>
		</path>
	    </then>
	</elseif>
	</if>
	<property name="local.includes" refid="local.includes-ref"/>
    </target>

    <target name="panda-init-opt" depends="property-init,native-init,arch-init" unless="native.debug">
	<property
		name="lfc.lib.dir"
		location="${package.home.lfc}/lib/optimized"/>
	<property
		name="panda.lib.dir"
		location="${package.home.panda}/lib/${panda.arch}/lfc-gm/no_threads/optimized"/>
    </target>
    <target name="panda-init-debug" depends="property-init,native-init,arch-init" if="native.debug">
	<property
		name="lfc.lib.dir"
		location="${package.home.lfc}/lib/debug"/>
	<property
		name="panda.lib.dir"
		location="${package.home.panda}/lib/${panda.arch}/lfc-gm/no_threads"/>
    </target>

    <target name="panda-init" depends="panda-init-opt,panda-init-debug">
    </target>


    <target name="panda-lib" depends="panda-init,property-init">
	<!-- ,native-compile -->
	<maplibrary property="library.path" name="${closure.lib}"/>
	<echo level="warning" message="The library is ${library.path}"/>
	<outofdate>
	    <sourcefiles>
		<fileset dir=".">
		    <include name="*.c"/>
		</fileset>
	    </sourcefiles>
	    <targetfiles>
		<pathelement path="${build}/lib/${library.path}"/>
	    </targetfiles>

	    <sequential>
		<echo message="Panda lib is ${panda.lib.dir}"/>
		<cc
			outfile="${build}/lib/${closure.lib}"
			outtype="shared"
			runtime="dynamic"
			warnings="severe"
			incremental="true"
			name="${c.compiler}"
			debug="${native.debug.value}">
		    <libset dir="${build}/lib"     libs="ibis_mp"/>
		    <libset dir="${panda.lib.dir}" libs="panda"/>
		    <libset dir="${lfc.lib.dir}"   libs="lfc"/>
		    <libset dir="${gm.lib.dir}"    libs="gm"/>
		    <includepath>
			<pathelement path="${local.includes}"/>
			<pathelement path="${default.includes}"/>
		    </includepath>
		    <defineset>
			<define name="NDEBUG" if="native.optimize"/>
		    </defineset>
		    <compilerarg value="-O3" if="native.optimize"/>
		    <fileset dir="." includes="*.c"/>
		</cc>
	    </sequential>
	</outofdate>
    </target>

    <target name="build"
	    depends="native-init,arch-init">
	<antcall target="panda-lib"/>
    </target>

</project>
