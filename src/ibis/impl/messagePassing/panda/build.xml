<!DOCTYPE project [
    <!ENTITY sharedProperties SYSTEM "../../../../build-properties.xml">
    <!ENTITY nativeTargets    SYSTEM "../../../../build-native.xml">
]>

<project
    name="ibis.ipl.impl.messagePassing.panda.native"
    default="build"
    basedir=".">

    <description>
	Compile natives in this directory

	Expect to inherit the following properties:
	    native.dir		the directory of this build
	    ibis		the root of the ibis source tree
	    native-path		${native.dir} relative to ${ibis}
	    build		the root of the ibis build tree
	    default.classpath	a ref property with default classpath

	The shared target definitions require you to define:
	    local.includes	a property that contains include paths specific
				to this module

	Optional:
	    local.lib		the truncated name of the lib you want to create
    </description>

    <property name="local.lib" value="ibis_local_mp_panda"/>
    <property name="closure.lib" value="ibis_mp_panda"/>

    <property name="panda"        location="/usr/local/VU/panda"/>
    <property name="daslib"       location="/usr/local/VU/daslib"/>

    <path id="local.includes-ref">
	<pathelement path="${native.dir}/../include"/>
	<pathelement path="${panda}/panda4.0/include"/>
	<pathelement path="${panda}/panda4.0/include/i386_linux/lfc/no_threads"/>
	<pathelement path="${daslib}/include"/>
    </path>
    <property name="local.includes" refid="local.includes-ref"/>

    &sharedProperties;
    &nativeTargets;


    <property name="gm"           location="/usr/local/gm/current"/>
    <property name="lfc"          location="/usr/local/VU/lfc/lfc-gm"/>

    <target name="panda-init-opt" depends="native-init" unless="native.debug">
	<path id="local.libs-ref">
	    <pathelement path="${daslib}/lib/i386_Linux/libdas.a"/>
	    <pathelement path="${gm}/lib/libgm.a"/>
	    <pathelement path="${lfc}/lib/optimized/liblfc.a"/>
	    <pathelement path="${panda}/panda4.0/lib/i386_linux/lfc/no_threads/optimized/libpanda.a"/>
	</path>
	<property name="local.libs" refid="local.libs-ref"/>
    </target>
    <target name="panda-init-debug" depends="native-init" if="native.debug">
	<path id="local.libs-ref">
	    <pathelement path="${daslib}/lib/i386_Linux/libdas.a"/>
	    <pathelement path="${gm}/lib/libgm.a"/>
	    <pathelement path="${lfc}/lib/debug/liblfc.a"/>
	    <pathelement path="${panda}/panda4.0/lib/i386_linux/lfc/no_threads/libpanda.a"/>
	</path>
	<property name="local.libs" refid="local.libs-ref"/>
    </target>
    <target name="panda-init" depends="panda-init-opt,panda-init-debug"/>

    <target name="-lib.current">
	<echo message="Now empty system library ${lib.current} into my lib.so"/>
	<exec
		dir="${build}/lib/so"
		executable="ar">
	    <arg line="xf ${lib.current}"/>
	</exec>
    </target>

    <target name="panda-lib" depends="panda-init,native-compile">
	<maplibrary property="library.path" name="${closure.lib}"/>
	<echo level="warning" message="The library is ${library.path}"/>
	<outofdate>
	    <sourcefiles>
		<pathelement path="${local.libs}"/>
		<fileset dir="${build}/ibis/${native-path}/..">
		    <include name="*.o"/>
		</fileset>
		<fileset dir="${build}/ibis/${native-path}">
		    <include name="*.o"/>
		</fileset>
	    </sourcefiles>
	    <targetfiles>
		<pathelement path="${build}/lib/${library.path}"/>
	    </targetfiles>

	    <sequential>
		<mkdir dir="${build}/lib/so"/>
		<foreach
			delimiter="${path.separator}"
			list="${local.libs}"
			param="lib.current"
			target="-lib.current"/>
		<copy
			todir="${build}/lib/so">
		    <fileset
			    dir="${build}/ibis/${native-path}/.."
			    includes="*.o"/>
		</copy>
		<copy
			todir="${build}/lib/so">
		    <fileset
			    dir="${build}/ibis/${native-path}"
			    includes="*.o"/>
		</copy>
		<cc
			outfile="${build}/lib/${closure.lib}"
			outtype="shared"
			warnings="severe"
			debug="${native.debug.value}">
		    <fileset dir="${build}/lib/so" includes="*.o"/>
		</cc>
		<delete dir="${build}/lib/so"/>
	    </sequential>
	</outofdate>
    </target>

    <target name="build"
	    depends="native-init,native-compile,panda-lib">
    </target>

</project>
