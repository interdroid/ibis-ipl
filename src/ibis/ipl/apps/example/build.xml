<project name="example runner" default="test-par" basedir=".">

    <description>
	Ibis example runner.
    </description>

    <property environment="env"/>
    <property name="ibis"         location="${env.IBIS_HOME}"/>

    <property name="java-args" value="" />

    <target name="set-ibis-name">

        <condition property="ibis-name" value="tcp">
            <not>
                <isset property="ibis-name" />
            </not>
        </condition>

        <condition property="define-ibis-name" value="&quot;-Dibis.name^=${ibis-name}&quot;">
            <os family="windows" />
        </condition>
        <condition property="define-ibis-name" value="-Dibis.name=${ibis-name}">
            <not>
                <isset property="define-ibis-name" />
            </not>
        </condition>
    </target>

    <target name="run2" depends="set-ibis-name">
        <exec dir="${basedir}" executable="${ibis}/bin/ibis-run" vmlauncher="false" spawn="true">
            <arg line="-Dibis.pool.size=2" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-name}" />
            <arg line="${java-args} ibis.util.Postpone 2 -o ant-test.out ${runjob}" />
        </exec>
        <exec dir="${basedir}" executable="${ibis}/bin/ibis-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="-Dibis.pool.size=2" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-name}" />
            <arg line="${java-args} ${runjob}" />
        </exec>
    </target>

    <target name="run1" depends="set-ibis-name">
        <exec dir="${basedir}" executable="${ibis}/bin/ibis-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="-Dibis.pool.size=1" />
            <arg line="-Dibis.pool.name=test-pool" />
            <arg line="-Dibis.server.address=localhost:8888" />
            <arg value="${define-ibis-name}" />
            <arg line="${java-args} ${runjob}" />
        </exec>
    </target>

    <target name="runseq">
        <exec dir="${basedir}" executable="${ibis}/bin/ibis-run" timeout="500000" failonerror="true" vmlauncher="false">
            <arg line="${java-args} ${runjob}" />
        </exec>
    </target>

    <target name="set-par-jargs-def" unless="test-par-java-args">
        <property name="jargs" value="" />
    </target>

    <target name="set-par-jargs-par" if="test-par-java-args">
        <property name="jargs" value="${test-par-java-args}" />
    </target>

    <target name="set-par-jargs" depends="set-par-jargs-def,set-par-jargs-par" />

    <target name="set-seq-jargs-def" unless="test-seq-java-args">
        <property name="jargs" value="" />
    </target>

    <target name="set-seq-jargs-seq" if="test-seq-java-args">
        <property name="jargs" value="${test-seq-java-args}" />
    </target>

    <target name="set-seq-jargs" depends="set-seq-jargs-def,set-seq-jargs-seq" />

    <target name="test-par" description="Run a parallel test if the property 'test-par-run' is set" depends="set-par-jargs" if="test-par-run">
        <echo message="Running parallel test on two JVM instances" />
        <antcall target="run2">
            <param name="runjob" value="${test-par-run}" />
            <param name="java-args" value="${jargs}" />
        </antcall>
        <echo message="Output of 2nd JVM" />
        <concat>
            <fileset dir="." includes="ant-test.out" />
        </concat>
    </target>

    <target name="test-seq" if="test-seq-run" depends="set-seq-jargs" description="Run a sequential test if the property 'test-seq-run' is set">
        <echo message="Running sequential test" />
        <antcall target="run1">
            <param name="runjob" value="${test-seq-run}" />
            <param name="java-args" value="${jargs}" />
        </antcall>
    </target>

</project>
