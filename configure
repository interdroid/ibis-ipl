#!/bin/sh

if [ x$IBIS_ROOT != x ]
then
	IBIS_ROOT_ENV=$IBIS_ROOT
fi

if [ -f configuration ]
then
        echo "Previous configuration read from file 'configuration'."
	echo "If you wish to discard the previous configuration,"
	echo "please remove or rename the file 'configuration'"
	echo "and run configure again."

	. configuration

	echo ""
	echo "Copied configuration:"
	cat configuration
	echo ""
fi

if [ x$IBIS_ROOT_ENV != x ]
then
	IBIS_ROOT=$IBIS_ROOT_ENV
elif [ x$IBIS_ROOT = x ]
then
	IBIS_ROOT=`cd ..; pwd`
fi
if [ x$JAVA_ROOT = x ]
then
	JAVA_ROOT=/usr/local/VU/jdk1.2.2
fi
if [ x$JAVAC = x ]
then
	JAVAC=$(JAVA_ROOT)/bin/javac
fi
if [ x$MANTA_ROOT = x ]
then
	MANTA_ROOT=/usr/local/VU/manta
fi
if [ x$BCEL_ROOT = x ]
then
	BCEL_ROOT=/home2/ceriel/bcel-5.1
fi
if [ x$PANDA_ROOT = x ]
then
	PANDA_ROOT=/usr/local/VU/panda
fi
if [ x$LFC_ROOT = x ]
then
	LFC_ROOT=/usr/local/VU/lfc
fi
if [ x$DAS_LIB = x ]
then
	DAS_LIB=/usr/proj/daslib/lib/i386_Linux/libdas.a
fi
if [ x$PANDA_NETWORK = x ]
then
	PANDA_NETWORK=lfc
fi
if [ x$GM_ROOT = x ]
then
	GM_ROOT=/usr/local/gm/current
fi

for i
do
	case $i in
	--java-root=*)
			JAVA_ROOT=`expr $i : '--java-root=\(.*\)'`
			;;
	--javac=*)
			JAVAC=`expr $i : '--javac=\(.*\)'`
			;;
	--ibis-root=*)
			IBIS_ROOT=`expr $i : '--ibis-root=\(.*\)'`
			;;
	--manta-root=*)
			MANTA_ROOT=`expr $i : '--manta-root=\(.*\)'`
			;;
	--panda-root=*)
			PANDA_ROOT=`expr $i : '--panda-root=\(.*\)'`
			;;
	--lfc-root=*)
			LFC_ROOT=`expr $i : '--lfc-root=\(.*\)'`
			;;
	--gm-root=*)
			GM_ROOT=`expr $i : '--gm-root=\(.*\)'`
			;;
	--das-lib=*)
			DAS_LIB=`expr $i : '--das-lib=\(.*\)'`
			;;
	--panda-network=*)
			PANDA_NETWORK=`expr $i : '--panda-network=\(.*\)'`
			;;
	--BCEL-root=*)
			BCEL_ROOT=`expr $i : '--BCEL-root=\(.*\)'`
			;;
	--help|-h|-?)
			echo configure [options]
			echo options:
			echo "	" option name "		" default
			echo "	" --java-root=PATH "	" $JAVA_ROOT
			echo "	" --javac=PATH "	" $JAVAC
			echo "	" --ibis-root=PATH "	" $IBIS_ROOT
			echo "	" --manta-root=PATH "	" $MANTA_ROOT
			echo "	" --panda-root=PATH "	" $PANDA_ROOT
			echo "	" --lfc-root=PATH "	" $LFC_ROOT
			echo "	" --gm-root=PATH "	" $GM_ROOT
			echo "	" --das-lib=PATH "	" $DAS_LIB
			echo "	" --panda-network=PATH " " $PANDA_NETWORK
			echo "	" --BCEL-root=PATH "	" $BCEL_ROOT
			exit 0
			;;
	*)
			echo No such option: $i -- ignored
	esac
done

if [ -f config.mk ]
then
	cp config.mk config.mk.old
fi

if [ -f config.mk.orig ]
then
	diff -c config.mk.orig config.mk > .config.mk.diff
else
	rm -f .config.mk.diff
fi

sed -e "
s+@JAVA_ROOT@+$JAVA_ROOT+
s+@JAVAC@+$JAVAC+
s+@IBIS_ROOT@+$IBIS_ROOT+
s+@MANTA_ROOT@+$MANTA_ROOT+
s+@PANDA_ROOT@+$PANDA_ROOT+
s+@LFC_ROOT@+$LFC_ROOT+
s+@GM_ROOT@+$GM_ROOT+
s+@DAS_LIB@+$DAS_LIB+
s+@PANDA_NETWORK@+$PANDA_NETWORK+
s+@BCEL_ROOT@+$BCEL_ROOT+
" < config.in > config.mk

cp config.mk config.mk.orig
if [ -f .config.mk.diff ]
then
	patch -p0 < .config.mk.diff
	rm .config.mk.diff
fi

echo "
JAVA_ROOT=$JAVA_ROOT
JAVAC=$JAVAC
IBIS_ROOT=$IBIS_ROOT
MANTA_ROOT=$MANTA_ROOT
PANDA_ROOT=$PANDA_ROOT
LFC_ROOT=$LFC_ROOT
GM_ROOT=$GM_ROOT
DAS_LIB=$DAS_LIB
PANDA_NETWORK=$PANDA_NETWORK
BCEL_ROOT=$BCEL_ROOT
" > configuration

cat scripts/preamble configuration scripts/ibisc > bin/ibisc
chmod +x bin/ibisc

cat scripts/preamble configuration scripts/io_gen > bin/io_gen
chmod +x bin/io_gen

cat scripts/preamble configuration scripts/ibis_nameserver > bin/ibis_nameserver
chmod +x bin/ibis_nameserver

cat scripts/preamble configuration scripts/jdis > bin/jdis
chmod +x bin/jdis

cat scripts/preamble configuration scripts/satinc > bin/satinc
chmod +x bin/satinc

cat scripts/preamble configuration scripts/run_ibis > bin/run_ibis
chmod +x bin/run_ibis

cat scripts/preamble configuration scripts/extract_jars > bin/extract_jars
chmod +x bin/extract_jars

cat scripts/preamble configuration scripts/tree_ioc > bin/tree_ioc
chmod +x bin/tree_ioc

cat scripts/preamble configuration scripts/run_ibis_wide_area > bin/run_ibis_wide_area
chmod +x bin/run_ibis_wide_area

(cd bin; sed "s+@IBIS_INSTALL_PATH@+\"$IBIS_ROOT\"+;s+@JAVA@+$JAVA_ROOT+" < cluster_wrapper.in > cluster_wrapper; chmod +x cluster_wrapper)

cat scripts/preamble configuration scripts/pprun_ibis > bin/pprun_ibis
chmod +x bin/pprun_ibis

cat scripts/preamble configuration scripts/csim_run_ibis > bin/csim_run_ibis
chmod +x bin/csim_run_ibis

(cd ipl; sed "s+@IBIS_INSTALL_PATH@+\"$IBIS_ROOT/ibis\"+" < InstallConfiguration.java.in > InstallConfiguration.java)
