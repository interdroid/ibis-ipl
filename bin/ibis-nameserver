#!/bin/sh

PRG="$0"

# resolve symlinks
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
    else
    PRG=`dirname "$PRG"`"/$link"
    fi
done

dir=`dirname "$PRG"`
dir=`cd "$dir" && pwd`

case X$IBIS_HOME in
X)
    IBIS_HOME=`cd "$dir/.." && pwd`
    ;;
esac

export IBIS_HOME

case "`uname`" in
CYGWIN*)
    IBIS_HOME=`cygpath --unix "$IBIS_HOME"`
    CLASSPATH=`cygpath --unix --path "$CLASSPATH"`
    ;;
esac

LIBCLASSPATH=""

add_to_libclasspath () {
    DIRLIBS=`cd "$1" && ls *.jar 2>/dev/null`
    for i in ${DIRLIBS}
    do
	if [ -z "$LIBCLASSPATH" ] ; then
	    LIBCLASSPATH="$1/$i"
	else
	    LIBCLASSPATH="$LIBCLASSPATH:$1/$i"
	fi
    done
}

# Add the following dirs to the classpath 
add_to_libclasspath "${IBIS_HOME}"/lib

case "`uname`" in
CYGWIN*)
    JAVACLASSPATH="$CLASSPATH:$LIBCLASSPATH:"
    JAVACLASSPATH=`cygpath --path --windows "$JAVACLASSPATH"`
    ;;
*)
    JAVACLASSPATH="$CLASSPATH:$LIBCLASSPATH:"
    ;;
esac

Ddefines=

args=
javaargs=

usage () {
    cat << 'EOF'
Usage:
  ibis-nameserver <nameserver parameters>

The nameserver parameters are:
-single
    make the nameserver only serve a single Ibis run. (In fact, it will
    server more than one run, but will exit as soon as no more runs are
    active).
-port <portno>
    make the nameserver listen to port number <portno>. The default
    port number is 9826.
-ns-port <portno>
    same as "-port".
-poolserver
    make the nameserver start a pool server (see ibis.util.PoolInfo in the
    Ibis API). This is the default.
-no-poolserver
    with this option, the nameserver does not start a pool server.
-poolport <poolportno>
    make the poolserver listen to port number <poolportno>. The default
    port number is the nameserver port number + 1.
-checker <interval>
    check all pools every <interval> seconds. Default is no checks.
-v
-verbose
    make the nameserver verbose
-?
-h
-help
--help
    print this message

Unrecognized options are passed on to java.

EOF
    exit 1
}

while [ $# -gt 0 ]
do
    case "$1" in
    -\?|-h|-help|--help)
	usage
	;;
    -checker)
	shift
	Ddefines="$Ddefines -Dibis.registry.checkerInterval=$1"
	;;
    -poolserver|-no-poolserver|-single)
	args="$args $1"
	;;
    -v|-verbose)
	args="$args -verbose"
	;;
    -port|-ns-port)
	shift
	Ddefines="$Ddefines -Dibis.registry.port=$1"
	;;
    -poolport|-pool-port)
	shift
	Ddefines="$Ddefines -Dibis.pool.server.port=$1"
	;;
    *)
	javaargs="$javaargs $1"
	;;
    esac
    shift
done

case X$JAVA_HOME in
X)
    JAVA=java
    ;;
*)
    JAVA="$JAVA_HOME/bin/java"
    ;;
esac

"$JAVA" -classpath "$JAVACLASSPATH" $Ddefines $javaargs ibis.impl.registry.tcp.NameServer $args
