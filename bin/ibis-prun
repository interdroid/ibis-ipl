#!/bin/sh

# This script can be used for running ibis applications with prun (which
# probably is only available on our own DAS system).

if [ -z "$IBIS_HOME" ];  then
    echo "please set IBIS_HOME to the location of your Ibis installation" 1>&2
    exit 1
fi

NHOSTS=`echo $PRUN_HOSTNAMES | awk '{print NF}'`
case X$1 in
X$PRUN_CPU_RANK)
	case X$2 in
	X$NHOSTS)
		# User probably forgot to pass the -no-panda flag
		shift
		shift
		;;
	esac
	;;
esac

pool="$PRUN_ENV"

function usage () {
cat << 'EOF'
Usage:
    prun -no-panda ibis-prun <ibis-prun params> <jvm params> <classname> <application params>
The first parameter that is not recognized as an option to ibis-prun
terminates the ibis-prun parameters.
Ibis-prun starts an ibis-server on the first host. If the user wants to use
his own server, -Dibis.server.address=<hostname> should do the trick
(or pass it on through an ibis.properties file).

The ibis-prun parameters are:
-cpdir <dir>
    add all jar files in the specified directory to the classpath.
-?
-h
-help
--help
    print this message
--
    terminates the parameters for ibis-prun; following parameters are passed
    on to java, even if they would be acceptable to ibis-prun
EOF
	exit 1
}

if [ -z "$1" -o $# -le 0 ]
then
	usage
fi

#
# parse arguments
#


# Jar-files from library.
LIBCLASSPATH=""
add_to_libclasspath () {
    JARFILES=`cd "$1" && ls *.jar 2>/dev/null`
    for i in ${JARFILES} ; do
	if [ -z "$LIBCLASSPATH" ] ; then
	    LIBCLASSPATH="$1/$i"
	else
	    LIBCLASSPATH="$LIBCLASSPATH:$1/$i"
	fi
    done
}


while [ $# -gt 0 ]
do
# echo now inspect argument $1 -- left $#
        case "$1" in
	-cpdir)
		shift
		add_to_libclasspath "$1"
		;;
	-\?|-h|-help|--help)
		usage
		;;
	--)
		shift
		break
		;;
        *)      
		break
                ;;
        esac
        shift
done

for i in $HOSTS
do
    serverhost=$i
    break
done

# Start an ibis-server on node 0.
case X$PRUN_CPU_RANK in
X0)
    $IBIS_HOME/bin/ibis-server < /dev/null > /dev/null 2>&1 &
    # $IBIS_HOME/bin/ibis-server < /dev/null > ns.out 2>&1 &
    PID=$!
esac

Dns_server="-Dibis.server.address=$serverhost"

# Put value of environment variable CLASSPATH in front, if present.
if [ -z "$CLASSPATH" ] ; then
    CLASSPATH="$LIBCLASSPATH"
else 
    CLASSPATH="$CLASSPATH:$LIBCLASSPATH"
fi

# Sleep for a second, to give ibis-server a chance to start.
# Should not be needed ...

sleep 1

. $IBIS_HOME/bin/ibis-run \
	-Dibis.pool.size=$NHOSTS \
	$Dns_server \
	-Dibis.pool.name="$pool" \
	"$@"

# Kill server 10 seconds after this ibis-run terminated.
# Not nice, but we cannot kill the server immediately, because other
# instances may still be active. In fact, this only works if all instances
# finish at about the same time.
# If this is not good enough, the user should have his own ibis-server.

case X$PRUN_CPU_RANK in
X0)
    sleep 10
    kill -9 $PID > /dev/null 2>&1
esac
