#!/bin/sh

# This script can be used for running ibis applications with prun (which
# probably is only available on our own DAS system).

if [ -z "$IBIS_HOME" ];  then
    echo "please set IBIS_HOME to the location of your Ibis installation" 1>&2
    exit 1
fi

# Check if user forgot no-panda flag. In that case, filter rank and nhosts.
NHOSTS=`echo $PRUN_HOSTNAMES | awk '{print NF}'`
case "X${1}X$2" in
X${PRUN_CPU_RANK}X$NHOSTS)
    shift
    shift
    ;;
esac

# Get the first host.
for i in $HOSTS
do
    serverhost=$i
    break
done

# Start an ibis-server on node 0.
case X$PRUN_CPU_RANK in
X0)
    $IBIS_HOME/bin/ibis-server < /dev/null > /dev/null 2>&1 &
    # $IBIS_HOME/bin/ibis-server < /dev/null > ns.out 2>&1 &
    PID=$!
esac

. $IBIS_HOME/bin/ibis-run \
	-Dibis.pool.size=$NHOSTS \
	"-Dibis.server.address=$serverhost" \
	-Dibis.pool.name="$PRUN_ENV" \
	"$@"

# Kill server 10 seconds after this ibis-run terminated.
# Not nice, but we cannot kill the server immediately, because other
# instances may still be active. In fact, this only works if all instances
# finish at about the same time.
# If this is not good enough, the user should have his own ibis-server.

case X$PRUN_CPU_RANK in
X0)
    sleep 10
    kill -9 $PID > /dev/null 2>&1
esac
