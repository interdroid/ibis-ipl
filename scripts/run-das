
#start of script template

if [ -z "$1" -o $# -le 0 ]
then
	echo "Usage:"
	echo "  $0 <JVM PARAMS> <CLASS NAME> <APPLICATION PARAMS>"
	echo "or, when using prun:"
	echo "  prun -1 -v -no-panda $0 <JVM PARAMS> <CLASS NAME> <APPLICATION PARAMS>"
	exit 1
fi

JAVACLASSPATH=$CLASSPATH:build:$IBIS_ROOT/classlibs:$IBIS_ROOT/build:

#needed for ibm 1.3 JITs and SMPs
export LD_ASSUME_KERNEL=2.2.5

#disable panda interrupts
#export IBP_NO_INTR=1

# fix panda/lfc flow control
#export LFC_SEND_COPY_ASIDE=1
#export PAN_SYS_CREDITS=65535

if [ -z $LFC_INTR_FIRST ] ; then
	export LFC_INTR_FIRST=100
fi
if [ -z $IBP_SEND_SYNC ] ; then
	export IBP_SEND_SYNC=100 
fi
if [ -z $PAN_COMM_NO_IDLE_POLL ] ; then
	export PAN_COMM_NO_IDLE_POLL=1
fi

#not needed any more, and not portable --Rob
#Dlibpath="-Dsun.boot.library.path=$IBIS_ROOT/build/lib:$JAVA_ROOT/jre/bin:$JAVA_ROOT/jre/lib/i386"

Dlibpath="-Djava.library.path=$IBIS_ROOT/build/lib:.::"

# This is the location where all ibis native libs must go.
# It must be *one* dir.
Dibislibs="-Dibis.library.path=$IBIS_ROOT/build/lib"

#PROFILING=-Xhprof:cpu=samples,file=profile.$1,depth=3
PROFILING=

cpumask="1"
attach=0

Dns_port="-Dibis.name_server.port=@IBIS_NS_PORT@"
Dns_server="-Dibis.name_server.host=@IBIS_NS_HOST@"

while [ $# -gt 0 ]
do
        qarg="'"$1"'"
        # qarg="$1"
# echo now inspect argument $1 -- left $#
        case "$1" in
	-attach)
		attach=1
		;;
        -cpu)
		shift
		cpumask="$1"
                ;;
	-no-pool)
		no_pool=1
		;;
	-ns)
		shift
		Dns_server="-Dibis.name_server.host=$1"
		;;
	-pg)
		shift
		gprof="$1"
		;;
	-p)
		shift
		prof="$1"
		;;
	-ns-port)
		shift
		Dns_port="-Dibis.name_server.port=$1"
		;;
        *)      java_args="$java_args $qarg"
                ;;
        esac
        shift
done


if [ -z "$no_pool" ] ; then
	NHOSTS=`echo $PRUN_HOSTNAMES | awk '{print NF}'`
	Dpool_total="-Dibis.pool.total_hosts=$NHOSTS"
	Dpool_host_num="-Dibis.pool.host_number=$PRUN_CPU_RANK"
	Dpool_host_names="-Dibis.pool.host_names=\"$HOSTS\""
else
	Dpool_total=
	Dpool_host_num=
	Dpool_host_names=
fi
if [ $attach -eq 1 ]
then
	JIT_OPTS="$JIT_OPTS -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n -Djava.compiler=NONE"
fi
if [ ! -z "$prof" ]
then
	JIT_OPTS="$JIT_OPTS -Xrunhprof:cpu=samples,depth=8,thread=y,file=$prof.$PRUN_CPU_RANK -Djava.compiler=NONE"
fi
if [ ! -z "$gprof" ]
then
	JIT_OPTS="$JIT_OPTS -Xrunhprof:cpu=times,depth=8,thread=y,file=$gprof.$PRUN_CPU_RANK -Djava.compiler=NONE"
fi

Dns_pool="-Dibis.name_server.key=$PANDA_HOST_PORT_KEY"

DEFAULT_USE_JAVA_WRAPPER=1

wrapper_name="$IBIS_ROOT/bin/java_wrapper"

# the -Xmx1024M must be here for the SUN JIT, it does not allocate enough mem for some satin apps --Rob

eval $wrapper_name -cpu $cpumask $JAVA_ROOT/bin/java $JIT_OPTS -Xmx1024M $Dlibpath $Dibislibs $Dpool_host_num $Dpool_total $Dpool_host_names $Dns_pool $Dns_port $Dns_server -Dibis.name_server.retry=yes -Xbootclasspath/p:$JAVACLASSPATH $PROFILING -classpath $JAVACLASSPATH $java_args
