<project
    name="properties"
    default="property-init"
    basedir=".">

    <description>
	Properties to be shared by all files, apps in Ibis

	Requires prior definition of the following properties:

	    ibis          the root of the Ibis tree

	Specify in this file:
    </description>

    <property name="build-properties.xml-imported" value="true"/>

    <target name="property-init"
	    depends="property-init-once"
	    unless="property.initialized">
	<property name="property.initialized" value="true"/>

	<path id="default.classpath">
	    <pathelement path="${ibisBuild}"/>
	    <pathelement path="${build}"/>
	    <pathelement path="${package.home.bcel}"/>
	</path>

	<echo	message="Now set default.classpath to ${default.classpath}"
		level="verbose"/>

	<if>
	    <os family="unix"/>
	    <then>
		<property name="os.family" value="unix"/>
	    </then>
	<elseif>
	    <os family="windows"/>
	    <then>
		<property name="os.family" value="windos"/>
	    </then>
	</elseif>
	<elseif>
	    <os family="mac"/>
	    <then>
		<property name="os.family" value="mac"/>
	    </then>
	</elseif>
	</if>

	<!--
	    Expand the settings in build-properties for optimized compilation
	    or debug symbol generation to more usable properties
	-->
	<if>
	    <equals arg1="${java.optimization}" arg2="optimize"/>
	    <then>
		<property name="java.optimize" value="true"/>
		<property name="java.optimize.value" value="true"/>
	    </then>
	    <else>
		<!-- The trick is to NOT set java.optimize -->
		<property name="java.optimize.value" value="false"/>
	    </else>
	</if>
	<if>
	    <isset property="java.debug"/>
	    <then>
		<property name="java.debug.value" value="true"/>
	    </then>
	    <else>
		<property name="java.debug.value" value="false"/>
	    </else>
	</if>
    </target>


    <target name="property-init-once"
	    depends="property-config-init,property-compiler-init,contrib-init,proprietary-tasks">
    </target>


    <target name="property-config-init">
	<!--
	    User-configured defines shared by all projects under ibis
	-->

	<property file="${ibis}/build-properties"/>

	<property name="ibisBuild"   location="${ibis}/build"/>
    </target>


    <target name="contrib-init"
	    depends="property-config-init">
	<echo level="verbose"
		message="ant-contrib home is ${package.home.ant-contrib}"/>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	    <classpath>
		<pathelement location="${package.home.ant-contrib}"/>
	    </classpath>
	</taskdef>
    </target>


    <target name="proprietary-tasks">
	<mkdir dir="${ibis}/ant-tasks/tasks"/>
	<javac
		srcdir="${ibis}/ant-tasks"
		destdir="${ibis}/ant-tasks/tasks">
	    <include name="**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
	<taskdef
		name="maplibrary"
		classname="MapLibraryName"
		classpath="${ibis}/ant-tasks/tasks"/>
	<taskdef
		name="hostname"
		classname="HostName"
		classpath="${ibis}/ant-tasks/tasks"/>
    </target>



    <!--
	Auxilliary target to run applications from ant
    -->
    <target name="run" depends="property-init">
	<property name="IBIS"      value="panda"/>
	<property name="SER"       value="ibis"/>
	<property name="HOSTS"     value="2"/>
	<property name="HOSTNAMES" value="athlon-win2000 p3"/>
	<exec outputproperty="hostname" executable="hostname"/>
	<echo message="My hostname is ${hostname}"/>
	<if>
	    <equals arg1="${hostname}" arg2="athlon-win2000"/>
	    <then>
		<property name="host.number" value="0"/>
	    </then>
	<elseif>
	    <equals arg1="${hostname}" arg2="p3"/>
	    <then>
		<property name="host.number" value="1"/>
	    </then>
	</elseif>
	</if>
	<java
		fork="true"
		classname="${MAIN}"
		classpath="build:${ibis}/build">
	    <sysproperty key="java.library.path"      value="${ibis}/build/lib"/>
	    <sysproperty key="ibis.name_server.host"  value="athlon-win2000"/>
	    <sysproperty key="ibis.name_server.port"  value="7654"/>
	    <sysproperty key="ibis.name_server.key"   value="rutger.0001"/>
	    <sysproperty key="ibis.pool.host_number"  value="${host.number}"/>
	    <sysproperty key="ibis.pool.total_hosts"  value="${HOSTS}"/>
	    <sysproperty key="ibis.pool.host_names"   value="${HOSTNAMES}"/>
	    <sysproperty key="ibis.name"              value="${IBIS}"/>
	    <sysproperty key="ibis.serialization"     value="${SER}"/>
	    <arg line="${ARGS}"/>
	</java>
    </target>


    <!--
	Auxilliary target to echo a prun command from ant
    -->
    <target name="prun" depends="property-init">
	<echo>
prun -v -1 -subst LFC_INTR_FIRST=100 IBP_SEND_SYNC=100 PAN_COMM_NO_IDLE_POLL=1 LD_LIBRARY_PATH=${ibis}/build/lib:.  CLASSPATH=build:${ibis}/build -no-panda ${ibis}/bin/java_wrapper 2 ${JAVA_HOME}/bin/java  -Xmx400M -Xcomp -Dibis.name_server.host=mercury.cs.vu.nl -Dibis.name_server.port=7654 -Dibis.name_server.key=rutger`${ibis}/bin/getpid` -Dibis.pool.host_number=%d -Dibis.pool.total_hosts=%n -Dibis.pool.host_names="%h" -Dibis.name=panda MAIN args...
	</echo>
    </target>

</project>
