<project
    name="rmic"
    default="rmic"
    basedir=".">

    <description>
	Ibis rmic target.

	Require prior definition of properties:
	default.classpath refid of classpath
	build             the root of the build tree, which contains all class files
    </description>

    <import file="${ibis}/build-properties.xml"/>

    <target name="property-rmic-build" unless="build">
	<echo message="build is undefined. Set it to the default value"/>
	<property name="build" location="build"/>
	<mkdir dir="${build}"/>
    </target>

    <target name="rmic-init"
	    depends="property-rmic-build,property-init"/>

    <target name="rmic"
	    depends="rmic-init"
	    description="Preprocess class files in the build tree for RMI">
	<!-- <echo message="Do ONLY the class files in ibis/ipl"/> -->

	<if>
	    <isset property="rmic-flags"/>
	    <then>
		<property name="rmic-flags.value" value="${rmic-flags}"/>
	    </then>
	    <else>
		<property name="rmic-flags.value" value=""/>
	    </else>
	</if>
	<path id="all-classes">
	    <fileset dir="${build}">
		<include name="**/*.class"/>
		<include name="ibis/ipl/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="classes.all" refid="all-classes">
	    <map from="${build}${file.separator}" to=""/>
	</pathconvert>

	<!--
	    Do regexp on ${classes.all} -> rmic-classes
		%s/.class//g
		%s/\${file.separator}/./g
	-->
	<echo message="${classes.all}" file="${build}/RMIC-Classes"/>
	<replaceregexp
		byline="true"
		file="${build}/RMIC-Classes"
		flags="g"
		match=".class"
		replace=""/>
	<replaceregexp
		byline="true"
		file="${build}/RMIC-Classes"
		flags="g"
		match="\${file.separator}"
		replace="."/>
	<loadfile
		property="rmic-classes"
		srcFile="${build}/RMIC-Classes">
	</loadfile>

	<echo	level="debug"
		message="All classes to be rewritten: ${rmic-classes}"/>
	<echo	level="debug"
		message="Run ibis rmic over all classes under ${build}${file.separator}"/>
	<java   classname="ibis.frontend.rmi.Main"
		taskname="ibis rmic"
		dir="${build}"
		failonerror="true"
		fork="true">
		<arg line="${rmic-flags.value} -dir -java2ibis ${rmic-classes}"/>
	    <classpath refid="default.classpath"/>
	</java>
	<javac	destdir="${build}"
		srcdir="${build}">
	    <include name="**/rmi_stub_*.java"/>
	    <include name="**/rmi_skeleton_*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>

</project>
