<project
    name="ibis"
    default="build"
    basedir=".">

    <description>
	Top-level Ibis build.
    </description>

    <property name="ibis"        location="."/>

    <!--
	This must come first.
	We cannot require ant-contrib before we have configured.
    -->
    <import file="${ibis}/build-config.xml"/>

    <import file="${ibis}/build-properties.xml"/>

    <property name="src"         location="${ibis}/src"/>
    <property name="build"       location="${ibis}/build"/>
    <property name="docs"        location="${ibis}/docs"/>

    <target name="init" depends="property-init">
	<tstamp/>

	<!--
	<property name="p-in" value="\\abc\\def"/>
	<echo message="p-in = ${p-in}"/>
	<propertyregex
		property="p-out"
		input="${p-in}"
		regexp="\\\\"
		replace="\\\\"
		global="true"/>
	<echo message="p-out = ${p-out}"/>
	-->

	<echo message="packages:"/>
	<echo message="package.home.bcel      = ${package.home.bcel}"/>
	<echo message="package.home.bcel-additions = ${package.home.bcel-additions}"/>
	<echo message="package.home.ant-contrib    = ${package.home.ant-contrib}"/>
	<echo message="package.home.ant-cpptasks   = ${package.home.ant-cpptasks}"/>
	<mkdir dir="${build}"/>

	<!--
	==============================================================
	    'sed' InstallConfiguration.java.in to InstallConfiguration.
	-->

	<!-- On M$ Windows, the path separator is '\'. Now, this happens
	    to be the escape character within Java strings. To get it
	    into the string, '\' itself must be escaped.
	-->
	<echo level="debug" message="Want to replace '\' with '\\' inside ${ibis}"/>
	<propertyregex
		property="ibis.escaped"
		input="${ibis}"
		regexp="\\"
		replace="\\\\\\\\"
		global="true"/>
	<!--
	    If the match failed, we need to copy the original value
	    by hand into ibis.escaped. :-(
	-->
	<property name="ibis.escaped" value="${ibis}"/>

	<copy
		file="${ibis}/src/ibis/ipl/InstallConfiguration.java.in"
		tofile="${ibis}/src/ibis/ipl/InstallConfiguration.java">
	    <filterchain>
		<filterreader
			classname="org.apache.tools.ant.filters.ReplaceTokens">
		    <param  type="token"
			    name="IBIS_INSTALL_PATH"
			    value='"${ibis.escaped}"'/>
		</filterreader>
	    </filterchain>
	</copy>

    </target>


    <!--
	We depend on bcel. I am not sure it should be inside Ibis,
	but there it is, so I include it in build.xml.
    -->
    <target name="bcel" depends="init">
	<javac  destdir="${build}"
		srcdir="${package.home.bcel-additions}">
	    <include name="**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <!--
	The list of directories that contain native sources.
    -->
    <path id="native.src.dirs">
	<!--
	-->
	<pathelement path="${ibis}/src/ibis/io"/>
	<pathelement path="${ibis}/src/ibis/impl/messagePassing"/>
	<pathelement path="${ibis}/src/ibis/impl/messagePassing/panda"/>
	<!--
	<pathelement path="${ibis}/src/ibis/impl/messagePassing/mpi"/>
	-->
	<pathelement path="${ibis}/src/ibis/impl/net/gm"/>
	<pathelement path="${ibis}/src/ibis/util/nativeCode"/>
	<!--
	-->
    </path>

    <property name="native.src.path" refid="native.src.dirs"/>


    <import file="${ibis}/build-iogen.xml"/>


    <target name="depend">
	<depend
		srcDir="${src}"
		destDir="${build}"
		cache="${build}/depCache"
		closure="yes"
		dump="true"
		/>
    </target>


    <!--
	Contains the list of directories where we want to compile sources
    -->
    <target name="compile"
	    depends="init,bcel"
	    description="Compile Ibis to .class">
	    <!-- depend" -->
	<echo message="java.debug.value = ${java.debug.value}"/>
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		listfiles="true"
		srcdir="${src}">

	    <include name="java/**/*.java"/>

	    <include name="ibis/frontend/**/*.java"/>
	    <include name="ibis/gmi/**/*.java"/>
	    <include name="ibis/io/**/*.java"/>

	    <include name="ibis/ipl/**/*.java"/>
	    <include name="ibis/impl/**/*.java"/>
	    <exclude name="ibis/impl/net/nio/**/*.java"/>
	    <exclude name="ibis/impl/net/muxer/tcp_blk/**/*.java"/>
	    <exclude name="ibis/impl/messagePassing/panda/**/*.java"/>

	    <include name="ibis/satin/**/*.java"/>
	    <include name="ibis/classfile/**/*.java"/>
	    <include name="ibis/rmi/**/*.java"/>
	    <include name="ibis/repmi/**/*.java"/>
	    <exclude name="ibis/repmi/Stub_manta_io_Generator.java"/>
	    <exclude name="ibis/repmi/Registry.java"/>
	    <exclude name="ibis/repmi/ReplicatedObject.java"/>
	    <include name="ibis/util/**/*.java"/>

	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <!--
	For a number of source modules, provide a separate target
	so we may compile only this source module, which is quicker.
    -->

    <target name="util" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/util/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="io" depends="init">
	<javac  destdir="${build}"
		debug="true">
	    <src path="io"/>
	    <classpath refid="default.classpath"/>
	    <include name="**/*.java"/>
	</javac>
    </target>


    <target name="frontend" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/frontend/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="satin" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/satin/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="ns" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/impl/nameServer/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
	<java	classname="ibis.impl.nameServer.NameServer"
		fork="true">
	    <classpath refid="default.classpath"/>
	    <arg line="-port 7654"/>
	</java>
    </target>


    <target name="mp" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/impl/messagePassing/**/*.java"/>
	    <exclude name="ibis/impl/messagePassing/panda/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="tcp" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/impl/tcp/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="net" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/impl/net/**/*.java"/>
	    <exclude name="ibis/impl/net/nio/**/*.java"/>
	    <exclude name="ibis/impl/net/muxer/tcp_blk/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <target name="rmi" depends="init">
	<javac  destdir="${build}"
		debug="${java.debug.value}"
		srcdir="${src}">
	    <include name="ibis/rmi/**/*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>


    <import file="${ibis}/build-native.xml"/>

    <!--
	Compile the native code in the directory indicated by native.dir
    -->
    <target name="-build-native">
	<echo	level="debug"
		message="Invoke ant in ${native.dir}"/>
	<ant inheritAll="false" dir="${native.dir}">
	    <property name="native.dir" value="${native.dir}"/>
	    <property name="build" value="${build}"/>
	    <property name="ibis" value="${ibis}"/>
	    <!--
	    <property name="optimization" value="${optimization}"/>
	    <property name="package.home.ant-cpptasks" value="${package.home.ant-cpptasks}"/>
	    <property name="package.home.ant-contrib" value="${package.home.ant-contrib}"/>
	    -->
	    <property name="contrib.initialized" value="${contrib.initialized}"/>
	</ant>
    </target>


    <!--
	Compile the native code in all directories indicated by native.src.path
    -->
    <target name="natives" depends="property-init">
	    <!-- depends="compile,javah"-->
	<echo	level="debug"
		message="Native directories = ${native.src.path}"/>
	<echo	level="debug"
		message="package.home.ant-cpptasks = ${package.home.ant-cpptasks}"/>
	<foreach
		list="${native.src.path}"
		delimiter="${path.separator}"
		param="native.dir"
		target="-build-native"/>
    </target>


    <!--
	Compile, run IOGenerator, compile native code for the whole of Ibis
    -->
    <target name="build"
	    description="Build Ibis">
	<antcall inheritAll="true" inheritRefs="true" target="compile"/>
	<antcall inheritAll="true" inheritRefs="true" target="iogen"/>
	<antcall inheritAll="true" inheritRefs="true" target="javah"/>
	<antcall inheritAll="true" inheritRefs="true" target="natives"/>
    </target>



    <!--
	Run IOGenerator over the classlibs in $JAVA_HOME and
	put them into ${rewritten-classlibs}
    -->

    <property name="rewritten-classlibs" location="${ibis}/classlibs"/>

    <target name="-rewrite-unjar-one">
	<echo level="warning" message="Now unjar ${jar.file}"/>
	<mkdir dir="${rewritten-classlibs}"/>
	<unjar src="${jar.file}" dest="${rewritten-classlibs}"/>
    </target>

    <target name="-rewrite-iogen-one">
	<path id="iogen-files-ref">
	    <fileset dir="${iogen.dir}">
		<include name="**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="iogen-one-files" refid="iogen-files-ref">
	    <map from="${rewritten-classlibs}${file.separator}" to=""/>
	</pathconvert>
	<echo	level="debug"
		message="Now try iogen over files ${iogen-one-files}"/>
	<antcall inheritRefs="true" target="iogen-files">
	    <param name="iogen-files" value="${iogen-one-files}"/>
	    <param name="iogen-build" value="${rewritten-classlibs}"/>
	</antcall>
    </target>

    <target name="rewrite" depends="init">
	<!--
	-->
	<path id="java.jar.ref">
	    <fileset dir="${JAVA_HOME}/jre/lib">
		<include name="**/*.jar"/>
	    </fileset>
	</path>
	<property name="java.jar.files" refid="java.jar.ref"/>
	<foreach
		list="${java.jar.files}"
		delimiter="${path.separator}"
		target="-rewrite-unjar-one"
		param="jar.file"/>

	<path id="java.classlibs.ref">
	    <dirset dir="${rewritten-classlibs}">
		<include name="*"/>
		<exclude name="META-INF"/>
		<exclude name="com"/>
	    </dirset>
	    <dirset dir="${rewritten-classlibs}">
		<include name="com/*"/>
	    </dirset>
	</path>
	<property name="java.classlibs.files" refid="java.classlibs.ref"/>
	<echo	level="debug"
		message="Rewrite each of ${java.classlibs.files}"/>
	<foreach
		list="${java.classlibs.files}"
		delimiter="${path.separator}"
		target="-rewrite-iogen-one"
		param="iogen.dir"/>
    </target>



    <target name="apps"
	    depends="build,bcel"
	    description="Build Ibis apps">
	<ant dir="apps"/>
    </target>


    <target name="clean">
	<delete dir="${rewritten-classlibs}"/>
	<delete dir="build"/>
	<delete dir="${docs}"/>
    </target>

    <target name="distclean" depends="clean">
	<delete file="build-properties"/>
	<delete file="config.mk"/>
	<delete file="config.mk.old"/>
	<delete file="config.mk.orig"/>
	<delete file="configuration.sh"/>
	<delete dir="bin"/>
    </target>

    <target name="docs" depends="init">
	<!-- Create the javadoc directory -->
	<delete dir="${docs}"/>
	<mkdir dir="${docs}"/>
	<copy
	    file="${ibis}/src/ibis/doc/overview.html"
	    tofile="${ibis}/docs/overview.html">
	</copy>
	<mkdir dir="${docs}/api"/>
	<javadoc packagenames="ibis.ipl,ibis.impl.*,ibis.gmi,ibis.rmi,ibis.io,ibis.satin" sourcepath="${src}" destdir="${docs}/api" author="true" version="true" use="true" windowtitle="Ibis Documentation" overview="${ibis}/docs/overview.html" doctitle="Ibis Documentation" bottom="The Ibis project">
	    <classpath refid="default.classpath"/>
	    <group title="Ibis GMI" packages="ibis.gmi"/>
	    <group title="Ibis RMI" packages="ibis.rmi"/>
	    <group title="Ibis IPL" packages="ibis.ipl*"/>
	    <group title="Ibis IO" packages="ibis.io"/>
	    <group title="Ibis Satin" packages="ibis.satin"/>
	</javadoc>
    </target>


</project>
